{% extends "base.html" %}
{% block content %}

<div class="mb-6">
  <h2 class="text-2xl font-semibold">Step 1 — Load data</h2>
  <p class="text-slate-600 mt-1">
    Upload a factor snapshot at a chosen <em>factor date</em>. We compute forward returns over the
    selected horizon starting strictly after that date (snapping to the next trading day if needed).
    Then we fetch returns up to your <em>Returns until</em> date.
  </p>

  {% if resolved_factor_dt or resolved_returns_end %}
    <div class="mt-3 flex flex-wrap gap-2">
      {% if resolved_factor_dt %}
        <div class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-sm text-indigo-700">
          <span class="font-medium">Resolved factor date:</span>
          <span class="tabular-nums">{{ resolved_factor_dt }}</span>
        </div>
      {% endif %}
      {% if resolved_returns_end %}
        <div class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-3 py-1 text-sm text-indigo-700">
          <span class="font-medium">Resolved returns until:</span>
          <span class="tabular-nums">{{ resolved_returns_end }}</span>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<form id="load-form"
      action="{{ url_for('data.data_step') }}"
      method="post"
      enctype="multipart/form-data"
      class="grid gap-6 mb-8 md:grid-cols-4">

  <label class="block">
    <span class="font-medium">Factor CSV</span>
    <input id="csv_file"
           type="file"
           name="csv_file"
           accept=".csv"
           required
           class="border border-dashed border-slate-300 rounded-lg p-3 w-full"
           aria-describedby="csv_help" />
    <p id="csv_help" class="text-xs text-slate-500 mt-1">
      Must include <code>Ticker</code> column. <code>Date</code> is optional — if missing, we'll use your Factor date.
    </p>
  </label>

  <label class="block">
    <span class="font-medium">Returns JSON <em class="text-slate-500">(optional)</em></span>
    <input id="returns_json"
           type="file"
           name="returns_json"
           accept=".json"
           class="border border-dashed border-slate-300 rounded-lg p-3 w-full"
           aria-describedby="json_help" />
    <p id="json_help" class="text-xs text-slate-500 mt-1">
      If omitted, prices are fetched automatically.
    </p>
  </label>

  <label class="block">
    <span class="font-medium">Factor date</span>
    <input id="factor_date_display"
           type="text"
           inputmode="numeric"
           placeholder="dd/mm/yyyy"
           class="border p-2 rounded w-full"
           required
           aria-describedby="factor_date_help" />
    <input id="factor_date" type="hidden" name="factor_date" />
    <p id="factor_date_help" class="text-xs text-slate-500 mt-1">
      Format: dd/mm/yyyy. If this falls on a holiday/weekend, we advance to the next date present in your CSV.
    </p>
  </label>

  <label class="block">
    <span class="font-medium">Returns until</span>
    <input id="returns_end_display"
           type="text"
           inputmode="numeric"
           placeholder="dd/mm/yyyy"
           class="border p-2 rounded w-full"
           required
           aria-describedby="returns_end_help" />
    <input id="returns_end" type="hidden" name="returns_end" />
    <p id="returns_end_help" class="text-xs text-slate-500 mt-1">
      Must be at least <span id="min_end_hint" class="tabular-nums">factor_date + horizon</span> and not after today.
    </p>
  </label>

  <div class="block">
    <label class="font-medium block mb-1" for="horizon">Forward horizon (days)</label>
    <div class="flex items-center gap-3">
      <input id="horizon"
             type="number"
             name="horizon"
             value="{{ horizon or 63 }}"
             min="1"
             class="border p-2 rounded w-28" />
      <div class="flex items-center gap-2">
        <button type="button" data-hz="21"  class="hz btn text-xs border px-2 py-1 rounded">21</button>
        <button type="button" data-hz="63"  class="hz btn text-xs border px-2 py-1 rounded">63</button>
        <button type="button" data-hz="126" class="hz btn text-xs border px-2 py-1 rounded">126</button>
        <button type="button" data-hz="252" class="hz btn text-xs border px-2 py-1 rounded">252</button>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-1" id="feasibility_hint">
      Feasibility check runs on submit: factor_date + horizon must not exceed today.
    </p>
  </div>

  <div class="flex items-end">
    <button id="load-submit"
            class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-60">
      Load data
    </button>
  </div>
</form>

{% if has_nans %}
  <div class="rounded-lg border border-slate-200 p-4 mb-8">
    <form action="{{ url_for('data.clean_step') }}" method="post" class="grid gap-4 md:grid-cols-3">
      <input type="hidden" name="horizon_current" value="{{ horizon }}">

      <div>
        <label class="block font-medium mb-1">Cleaning method</label>
        <select name="clean_method" class="border p-2 rounded w-full">
          <option value="drop">Drop cols</option>
          <option value="mean">Mean impute</option>
          <option value="median">Median impute</option>
          <option value="knn">K-NN impute</option>
          <option value="iterative">Iterative (MICE)</option>
        </select>
        <p class="text-xs text-slate-500 mt-1">
          Note: <em>Drop cols</em> drops any column with missing values and
          ignores the threshold below. Impute methods apply the threshold first.
        </p>
      </div>

      <div>
        <label class="block font-medium mb-1">NaN-column threshold (0 - 1)</label>
        <input type="number"
               name="drop_thresh"
               value="0.10"
               min="0"
               max="1"
               step="0.05"
               class="border p-2 rounded w-32" />
        <p class="text-xs text-slate-500 mt-1">
          Columns with a higher NaN ratio are removed <em>before</em> imputing.
        </p>
      </div>

      <div class="flex items-end">
        <button type="submit"
                class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">
          Clean data
        </button>
      </div>
    </form>
  </div>
{% endif %}

<div class="grid gap-8">
  {% if table %}
    <div class="rounded-lg border border-slate-200 p-4">
      <h3 class="text-xl font-medium mb-2">Factor sample</h3>
      <p class="text-slate-500 text-sm mb-3">First rows of your factor matrix at the snapshot date.</p>
      {{ table|safe }}
    </div>
  {% endif %}

  {% if heatmap %}
    <div class="rounded-lg border border-slate-200 p-4">
      <h3 class="text-xl font-medium mb-2">Correlation heatmap</h3>
      <p class="text-slate-500 text-sm mb-3">Pearson correlations across numeric factors.</p>
      {{ heatmap|safe }}
    </div>
  {% endif %}

  {% if hist %}
    <div class="rounded-lg border border-slate-200 p-4">
      <h3 class="text-xl font-medium mb-2">Forward-return histogram</h3>
      <p class="text-slate-500 text-sm mb-3">Distribution of {{ horizon or 63 }}-day forward returns at the snapshot.</p>
      {{ hist|safe }}
    </div>
  {% endif %}
</div>

<script>
  document.querySelectorAll('.hz.btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const hz = btn.getAttribute('data-hz');
      const input = document.getElementById('horizon');
      if (input && hz) {
        input.value = hz;
        recomputeMinEnd();
        syncHidden();
      }
    });
  });

  function pad2(n){ return String(n).padStart(2,'0'); }
  function isValidDMY(s){
    const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(s);
    if(!m) return false;
    const d = Number(m[1]), mo = Number(m[2]), y = Number(m[3]);
    const dt = new Date(y, mo-1, d);
    return dt.getFullYear()===y && (dt.getMonth()+1)===mo && dt.getDate()===d;
  }
  function dmyToISO(s){
    if(!isValidDMY(s)) return null;
    const [d, m, y] = s.split('/').map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toISOString().slice(0,10);
  }
  function isoToDMY(iso){
    const dt = new Date(iso + 'T00:00:00');
    return pad2(dt.getDate()) + '/' + pad2(dt.getMonth()+1) + '/' + dt.getFullYear();
  }
  function addDaysISO(iso, days){
    const dt = new Date(iso + 'T00:00:00');
    dt.setDate(dt.getDate() + Number(days||0));
    return dt.toISOString().slice(0,10);
  }
  function todayISO() {
    const t = new Date();
    const y = t.getFullYear();
    const m = String(t.getMonth() + 1).padStart(2, '0');
    const d = String(t.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  const factorDisp = document.getElementById('factor_date_display');
  const returnsDisp = document.getElementById('returns_end_display');
  const factorISO = document.getElementById('factor_date');   // hidden
  const returnsISO = document.getElementById('returns_end');   // hidden
  const horizonInput = document.getElementById('horizon');
  const hintSpan = document.getElementById('min_end_hint');

  function recomputeMinEnd(){
    if(!factorDisp.value || !horizonInput.value) return;
    const isoFD = dmyToISO(factorDisp.value);
    if(!isoFD) return;
    const minEndISO = addDaysISO(isoFD, horizonInput.value);
    const today = todayISO();
    if(hintSpan) hintSpan.textContent = isoToDMY(minEndISO);
  }

  function syncHidden() {
    factorISO.value  = dmyToISO(factorDisp.value)  || '';
    returnsISO.value = dmyToISO(returnsDisp.value) || '';
  }

  [factorDisp, returnsDisp, horizonInput].forEach(el => {
    if(el) el.addEventListener('input', () => { syncHidden(); recomputeMinEnd(); });
  });

  (function initDefaults(){
    const tISO = todayISO();
    if(!returnsDisp.value) returnsDisp.value = isoToDMY(tISO);
    syncHidden();
    recomputeMinEnd();
  })();

  const form = document.getElementById('load-form');
  const submitBtn = document.getElementById('load-submit');
  if(form && submitBtn){
    form.addEventListener('submit', (e)=>{
      syncHidden();
      const tISO  = todayISO();
      const fdISO = factorISO.value;
      const reISO = returnsISO.value;
      const hz = Number(horizonInput.value||0);

      if(!fdISO || !reISO || !hz || hz < 1 || !isValidDMY(factorDisp.value) || !isValidDMY(returnsDisp.value)){
        e.preventDefault();
        alert('Please enter valid dates in dd/mm/yyyy and a positive horizon.');
        return;
      }

      const minEndISO = addDaysISO(fdISO, hz);
      if(minEndISO > tISO){
        e.preventDefault();
        alert('Forward horizon not feasible: factor_date + horizon exceeds today.');
        return;
      }
      if(!isValidDMY(returnsDisp.value)){
        e.preventDefault();
        alert('Invalid Returns until date — must be in dd/mm/yyyy format.');
        return;
      }
      if(reISO < minEndISO){
        e.preventDefault();
        alert('Returns until must be at least factor_date + horizon.');
        return;
      }
      if(reISO > tISO){
        e.preventDefault();
        alert('Returns until cannot be after today.');
        return;
      }
      submitBtn.disabled = true;
      submitBtn.textContent = 'Loading…';
    });
  }
</script>

{% endblock %}
